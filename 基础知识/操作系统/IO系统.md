## 死锁

一组进程中，每个进程都无限等待被该组进程中另一进程所占有的资源，因而永远无法得到的资源，这种现象称为进程死锁。

### 出现死锁的原因

资源数量有限、锁和信号量错误使用

从资源的角度：

资源的使用方式：申请-分配-使用-释放 模式

资源的分类：

* 可重用资源：可被多个进程多次使用
  * 可抢占资源与不可抢占资源
  * 处理器、I/O部件、内存、文件、数据库、信号量
* 可消耗资源：只使用一次、可创建和销毁的资源
  * 信号、中断、消息

#### 活锁

先加锁，再轮询，既无进展也没有阻塞

#### 饥饿

资源分配策略决定

### 产生死锁的必要条件

* 互斥使用（资源独占）：一个资源每次只能给一个进程使用
* 占用且等待（请求和保持，部分分配）：进程在申请新的资源的同时保持对原有资源的占有
* 不可抢占（不可剥夺）：资源申请者不能强行的从资源占有者手中夺取资源，资源只能由占有者自愿释放
* 循环等待：存在一个进程等待队列{P1,P2,...,Pn}，其中P1等待P2占有的资源，P2等待P3占有的资源，Pn等待P1占有的资源，形成一个进程等待环路。

### 资源分配图

用有向图描述系统资源和进程的状态

二元组G=(V,E)

V:结点的集合，分为P(进程)，R（资源）两部分。P={P1,P2,,...,Pn}，R={R1,R2,...,Rm}

E:有向边的集合，其元素为有序二元组（Pi,Rj）或(Rj,Pi)

分配边：资源实列->进程

申请边:进程->资源类

#### 死锁定理 

* 如果资源分配图中没有环路，则系统中没有死锁，如果图中存在环路则系统中可能存在死锁
* 如果每个资源类中只包含一个资源实例，则环路是死锁存在的充分必要条件

#### 资源分配图化简

1. 找一个非孤立、且只有分配边的进程结点，去掉分配边，将其变为孤立结点
2. 再把相应的资源分配给一个等待该资源的进程，即将该进程的申请边变为分配边
3. 重复1和2

### 解决死锁的方法

* 不考虑此问题（鸵鸟算法）
* 不让死锁发生
  * 死锁预防（静态策略）：设计合适的资源分配算法，不让死锁发生
  * 死锁避免（动态策略）：以不让死锁发生为目标，跟踪并评估资源分配过程，根据评估结果决策是否分配
* 让死锁发生
  * 死锁检测与解除

#### 死锁预防

在设计系统时，通过资源分配算法，排除发生死锁的可能性

具体的做法是：**防止产生死锁的四个必要条件中任何一个条件发生**

* 破坏”互斥使用/资源独占“条件
  * 资源转换技术：把独占资源变为共享资源
  * SPOOLing技术的引入：设计一个”守护进程/线程“负责管理打印机，进程需要打印时，将请求发给该daemon，由它完成打印任务
* 破坏”占有且等待”条件
  * 实现方案1：要求每个进程在运行前必须一次性申请它所要求的所有资源，且仅当该进程所要资源均可满足时才给予一次性分配（问题：资源利用率低，“饥饿”现象）
  * 实现方案2：在允许进程动态申请资源前提下规定，一个进程在申请新的资源不能立即得到满足而变为等待状态之前，必须释放已占有的全部资源，若需要再重新申请
* 破坏 “不可抢占“条件
  * 实现方案：当一个进程申请的资源被其他进程占用时，可以通过操作系统抢占这一资源（两个进程优先级不同）。局限性：适用于状态易于保存和恢复的资源（CPU、内存）
* 破坏”循环等待“条件
  * 实施方案：资源有序分配法。把系统中所有资源编号，进程在申请资源时必须严格按资源编号的递增次序进行，否则操作系统不予分配。

#### 死锁避免

在系统运行过程中，对进程发出的每一个系统能够满足的资源申请进行动态检查，并根据检查结果决定是否分配资源，若分配后系统发生死锁或可能发生死锁，则不予分配，否则予以分配。

##### 安全状态

如果系统中存在一个由所有进程构成的安全序列P1,...,Pn,则称系统处于安全状态（安全状态一定没有死锁发生）。

安全序列：一个进程序列{P1,...,Pn}是安全的，如果对于每一个进程Pi（1<=i<=n），它以后还需要的资源量不超过系统当前剩余资源量与所有进程Pj(j<i)当前占有资源量之和。

##### 不安全状态

系统中不存在一个安全序列。不安全状态一定导致死锁

##### 银行家算法

#### 死锁的检测与解除

死锁的检测：

* 允许死锁发生，但是操作系统会不断监视系统进展情况，判断死锁是否真的发生
* 一旦死锁发生则采取专门的措施，解除死锁并以最小的代价恢复操作系统运行

检测的时机：

* 当进程由于资源请求不满足而等待时检测死锁（缺点：系统开销大）
* 定时检测
* 系统资源利用率下降时检测死锁

死锁的解除：

以最小的代价恢复系统的运行

* 撤销所有死锁进程
* 进程回退再启动
* 按照某种原则逐一撤销死锁进程，直到。。。
* 按照某种原则逐一抢占资源（资源被抢占的进程必须回退到之前的对应状态），直到...

#### 哲学家进餐问题